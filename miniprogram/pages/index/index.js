import { wxRequest } from '../../utils/request';
import { CONSTANT_SESSIONDATA_KEY } from '../../utils/constant';
const WXBizDataCrypt = require('../../utils/RdWXBizDataCrypt');
Page({
    app: getApp(),
    data: {
        sessionKey: "",
        rules: [{
                name: 'user',
                rules: { required: true, message: '帐号必填' },
            }, {
                name: 'pwd',
                rules: { required: true, message: '密码必填' },
            }],
        formData: {
            user: "",
            pwd: ""
        },
        msgShow: false,
        error: '',
        isCom: getApp().globalData.isCom,
    },
    bindMsgHide() {
        this.setData({
            msgShow: false,
        });
    },
    onShowUser() {
        this.setData({
            showUserDialog: true
        });
    },
    onUserConfirm() {
        const that = this;
        this.selectComponent('#form').validate((valid, errors) => {
            if (!valid) {
                const firstError = Object.keys(errors);
                if (firstError.length) {
                    this.setData({
                        error: errors[firstError[0]].message
                    });
                }
            }
            else {
                const { user, pwd } = this.data.formData;
                that.login(user, pwd, true);
            }
        });
    },
    setError(errMsg) {
        this.setData({
            error: errMsg,
            msgShow: true,
        });
    },
    formInputChange(e) {
        const { field } = e.currentTarget.dataset;
        this.setData({
            [`formData.${field}`]: e.detail.value
        });
    },
    comLogin() {
        const that = this;
        const app = getApp();
        wx.qy.login({
            success: function (res) {
                if (res.code) {
                    wxRequest({
                        url: "https://wechat-api.gzmpc.com/v1/com/code2Session",
                        method: 'POST',
                        data: {
                            agentId: app.globalData.agentId,
                            jsCode: res.code,
                        }
                    }).then((res) => {
                        if (res.statusCode == 200) {
                            const data = res.data;
                            const result = data;
                            if (result.errcode === 0) {
                                const sessionData = { ...result };
                                app.globalData.comSessionData = sessionData;
                                wx.setStorageSync(CONSTANT_SESSIONDATA_KEY, sessionData);
                                that.login(sessionData.userid, "mima");
                            }
                        }
                        else {
                        }
                    });
                }
                else {
                    console.log('登录失败！' + res.errMsg);
                }
            }
        });
    },
    login(user, pwd, bind = false) {
        const app = getApp();
        const that = this;
        wxRequest({
            header: {
                'content-type': 'application/x-www-form-urlencoded',
            },
            url: "/login",
            method: 'POST',
            data: {
                username: '10972',
                password: pwd
            }
        }).then((res) => {
            if (res.statusCode == 200) {
                const data = res.data;
                app.setAccountInfo(user, data.data.token);
                wx.switchTab({ url: "/pages/list/list" });
                if (bind && !app.globalData.isCom) {
                    const sessionData = app.getSessionCache();
                    if (sessionData) {
                        wxRequest({
                            url: "https://wechat-api.gzmpc.com/v1/wechat/bindOpenId",
                            method: 'POST',
                            data: {
                                uaccount: user,
                                openid: sessionData.openid
                            }
                        }).then((res) => {
                            if (res.statusCode == 200) {
                            }
                        });
                    }
                }
            }
            else {
                that.setError(res.errMsg);
            }
        })
            .catch((res) => {
            that.setError(res.errMsg);
        });
    },
    onLoad(option) {
        const { auto } = option;
        const { app } = this;
        const that = this;
        if (!app.globalData.isCom) {
            const sessionData = app.getSessionCache();
            if (sessionData && !auto) {
                wxRequest({
                    url: `https://wechat-api.gzmpc.com/v1/wechat/getUaccountByOpenId/${sessionData.openid}`,
                }).then((res) => {
                    if (res.statusCode == 200) {
                        const data = res.data;
                        if (data && data.errcode == 0) {
                            that.login(data.uaccount, "mima");
                        }
                    }
                });
            }
        }
        else {
            wx.qy.checkSession({
                success: function () {
                    const sessionData = app.getComSessionCache();
                    if (sessionData) {
                        that.login(sessionData.userid, "mima");
                    }
                    that.comLogin();
                },
                fail: function () {
                    that.comLogin();
                }
            });
        }
    },
    getUserInfo(e) {
        const app = getApp();
        app.globalData.userInfo = e.detail.userInfo;
        this.onUserConfirm();
    },
    getPhoneNumber(e) {
        const { app } = this;
        const that = this;
        wx.checkSession({
            success: function (res) {
                console.log(res);
                var ency = e.detail.encryptedData;
                var iv = e.detail.iv;
                var sessionk = that.data.sessionKey;
                console.log('session data: ', e, ency, iv, sessionk);
                const errMsg = e.detail.errMsg;
                if (errMsg && errMsg.startsWith('getPhoneNumber:fail')) {
                    that.setData({
                        modalstatus: true
                    });
                }
                else {
                    const pc = new WXBizDataCrypt(app.globalData.appId, sessionk);
                    var data = pc.decryptData(ency, iv);
                    console.log('解密后 data: ', data);
                }
            },
            fail: function () {
                console.log("session_key 已经失效，需要重新执行登录流程");
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDaEQsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHaEUsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLDhCQUE4QixDQUFDLENBQUM7QUFFL0QsSUFBSSxDQUFDO0lBQ0gsR0FBRyxFQUFFLE1BQU0sRUFBYTtJQUN4QixJQUFJLEVBQUU7UUFDSixVQUFVLEVBQUUsRUFBRTtRQUNkLEtBQUssRUFBRSxDQUFDO2dCQUNOLElBQUksRUFBRSxNQUFNO2dCQUNaLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRTthQUMzQyxFQUFFO2dCQUNELElBQUksRUFBRSxLQUFLO2dCQUNYLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRTthQUMzQyxDQUFDO1FBQ0YsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLEVBQUU7WUFDUixHQUFHLEVBQUUsRUFBRTtTQUNSO1FBQ0EsT0FBTyxFQUFFLEtBQUs7UUFDZCxLQUFLLEVBQUUsRUFBRTtRQUNULEtBQUssRUFBRSxNQUFNLEVBQWEsQ0FBQyxVQUFVLENBQUMsS0FBSztLQUM3QztJQUVELFdBQVc7UUFDVixJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1osT0FBTyxFQUFHLEtBQUs7U0FDZixDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsVUFBVTtRQUNSLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxjQUFjLEVBQUUsSUFBSTtTQUNyQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsYUFBYTtRQUNYLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQVUsRUFBRSxNQUFXLEVBQUUsRUFBRTtZQUNqRSxJQUFJLENBQUMsS0FBSyxFQUFFO2dCQUNWLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7Z0JBQ3RDLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtvQkFDckIsSUFBSSxDQUFDLE9BQU8sQ0FBQzt3QkFDWCxLQUFLLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU87cUJBQ3JDLENBQUMsQ0FBQTtpQkFDSDthQUNGO2lCQUFNO2dCQUNMLE1BQU0sRUFBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUM1QjtRQUNILENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELFFBQVEsQ0FBQyxNQUFjO1FBQ3JCLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxLQUFLLEVBQUUsTUFBTTtZQUNiLE9BQU8sRUFBRSxJQUFJO1NBQ2QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGVBQWUsQ0FBQyxDQUFNO1FBQ3BCLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQTtRQUN6QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsQ0FBQyxZQUFZLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLO1NBQ3RDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRCxRQUFRO1FBQ04sTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLE1BQU0sR0FBRyxHQUFHLE1BQU0sRUFBYSxDQUFDO1FBQ2hDLEVBQUUsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDO1lBQ1YsT0FBTyxFQUFFLFVBQVMsR0FBc0M7Z0JBQ3RELElBQUksR0FBRyxDQUFDLElBQUksRUFBRTtvQkFFWixTQUFTLENBQUM7d0JBQ1IsR0FBRyxFQUFFLGtEQUFrRDt3QkFDdkQsTUFBTSxFQUFFLE1BQU07d0JBQ2QsSUFBSSxFQUFFOzRCQUNKLE9BQU8sRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLE9BQU87NEJBQy9CLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSTt5QkFDakI7cUJBQ0YsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO3dCQUNkLElBQUksR0FBRyxDQUFDLFVBQVUsSUFBSSxHQUFHLEVBQUU7NEJBQ3pCLE1BQU0sSUFBSSxHQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUM7NEJBQzNCLE1BQU0sTUFBTSxHQUEyQyxJQUFJLENBQUM7NEJBQzVELElBQUcsTUFBTSxDQUFDLE9BQU8sS0FBSyxDQUFDLEVBQUU7Z0NBQ3ZCLE1BQU0sV0FBVyxHQUFtQixFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7Z0NBQ2xELEdBQUcsQ0FBQyxVQUFVLENBQUMsY0FBYyxHQUFHLFdBQVcsQ0FBQztnQ0FHNUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUMsQ0FBQztnQ0FFekQsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDOzZCQUN4Qzt5QkFDRjs2QkFDSTt5QkFFSjtvQkFDSCxDQUFDLENBQUMsQ0FBQztpQkFDSjtxQkFBTTtvQkFDTCxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7aUJBQ2xDO1lBQ0gsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLENBQUMsSUFBWSxFQUFFLEdBQVcsRUFBRSxPQUFnQixLQUFLO1FBQ3BELE1BQU0sR0FBRyxHQUFHLE1BQU0sRUFBYSxDQUFDO1FBQ2hDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixTQUFTLENBQUM7WUFDUixNQUFNLEVBQUc7Z0JBQ1AsY0FBYyxFQUFHLG1DQUFtQzthQUNyRDtZQUNELEdBQUcsRUFBRSxRQUFRO1lBQ2IsTUFBTSxFQUFFLE1BQU07WUFDZCxJQUFJLEVBQUU7Z0JBQ0osUUFBUSxFQUFFLE9BQU87Z0JBQ2pCLFFBQVEsRUFBRSxHQUFHO2FBQ2Q7U0FDRixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDZCxJQUFHLEdBQUcsQ0FBQyxVQUFVLElBQUksR0FBRyxFQUFFO2dCQUN4QixNQUFNLElBQUksR0FBUSxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUMzQixHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUMxQyxFQUFFLENBQUMsU0FBUyxDQUFDLEVBQUMsR0FBRyxFQUFFLGtCQUFrQixFQUFDLENBQUMsQ0FBQztnQkFFeEMsSUFBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRTtvQkFDaEMsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLGVBQWUsRUFBRSxDQUFDO29CQUMxQyxJQUFHLFdBQVcsRUFBRTt3QkFDZCxTQUFTLENBQUM7NEJBQ1IsR0FBRyxFQUFFLG1EQUFtRDs0QkFDeEQsTUFBTSxFQUFFLE1BQU07NEJBQ2QsSUFBSSxFQUFFO2dDQUNKLFFBQVEsRUFBRSxJQUFJO2dDQUNkLE1BQU0sRUFBRSxXQUFXLENBQUMsTUFBTTs2QkFDM0I7eUJBQ0YsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFOzRCQUNkLElBQUcsR0FBRyxDQUFDLFVBQVUsSUFBSSxHQUFHLEVBQUU7NkJBRXpCO3dCQUNILENBQUMsQ0FBQyxDQUFDO3FCQUNKO2lCQUNGO2FBQ0Y7aUJBQ0k7Z0JBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDM0I7UUFDSCxDQUFDLENBQUM7YUFDRCxLQUFLLENBQUMsQ0FBQyxHQUE0QyxFQUFFLEVBQUU7WUFDdEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsTUFBTSxDQUFDLE1BQVc7UUFDaEIsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sQ0FBQztRQUN4QixNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUVsQixJQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUU7WUFDeEIsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQzFDLElBQUcsV0FBVyxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUN2QixTQUFTLENBQUM7b0JBQ1IsR0FBRyxFQUFFLDhEQUE4RCxXQUFXLENBQUMsTUFBTSxFQUFFO2lCQUN4RixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7b0JBQ2QsSUFBRyxHQUFHLENBQUMsVUFBVSxJQUFJLEdBQUcsRUFBRTt3QkFDeEIsTUFBTSxJQUFJLEdBQVEsR0FBRyxDQUFDLElBQUksQ0FBQzt3QkFDM0IsSUFBRyxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLEVBQUU7NEJBQzVCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQzt5QkFDbkM7cUJBQ0Y7Z0JBQ0gsQ0FBQyxDQUFDLENBQUM7YUFDSjtTQUNGO2FBQ0k7WUFDSCxFQUFFLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQztnQkFDakIsT0FBTyxFQUFFO29CQUVQLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO29CQUM3QyxJQUFHLFdBQVcsRUFBRTt3QkFDZCxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7cUJBQ3hDO29CQUNELElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDbEIsQ0FBQztnQkFDRCxJQUFJLEVBQUU7b0JBRUosSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUNsQixDQUFDO2FBQ0YsQ0FBQyxDQUFBO1NBQ0g7SUFDSCxDQUFDO0lBQ0QsV0FBVyxDQUFDLENBQU07UUFDaEIsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFhLENBQUM7UUFDaEMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDNUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxjQUFjLENBQUMsQ0FBTTtRQUNuQixNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixFQUFFLENBQUMsWUFBWSxDQUFDO1lBQ2QsT0FBTyxFQUFFLFVBQVUsR0FBRztnQkFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakIsSUFBSSxJQUFJLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7Z0JBQ2xDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO2dCQUNyQixJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztnQkFDcEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDckQsTUFBTSxNQUFNLEdBQVUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQ3RDLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMscUJBQXFCLENBQUMsRUFBRTtvQkFDdEQsSUFBSSxDQUFDLE9BQU8sQ0FBQzt3QkFDWCxXQUFXLEVBQUUsSUFBSTtxQkFDbEIsQ0FBQyxDQUFDO2lCQUNKO3FCQUFNO29CQUNMLE1BQU0sRUFBRSxHQUFHLElBQUksY0FBYyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDO29CQUU5RCxJQUFJLElBQUksR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRyxFQUFFLENBQUMsQ0FBQTtvQkFDcEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLENBQUE7aUJBQ2hDO1lBQ0gsQ0FBQztZQUNELElBQUksRUFBRTtnQkFDSixPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixDQUFDLENBQUM7WUFFN0MsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbmRleC50c1xuaW1wb3J0IHsgd3hSZXF1ZXN0IH0gZnJvbSAnLi4vLi4vdXRpbHMvcmVxdWVzdCc7XG5pbXBvcnQgeyBDT05TVEFOVF9TRVNTSU9OREFUQV9LRVkgfSBmcm9tICcuLi8uLi91dGlscy9jb25zdGFudCc7XG5cblxuY29uc3QgV1hCaXpEYXRhQ3J5cHQgPSByZXF1aXJlKCcuLi8uLi91dGlscy9SZFdYQml6RGF0YUNyeXB0Jyk7XG5cblBhZ2Uoe1xuICBhcHA6IGdldEFwcDxCcG1PcHRpb24+KCksXG4gIGRhdGE6IHtcbiAgICBzZXNzaW9uS2V5OiBcIlwiLFxuICAgIHJ1bGVzOiBbe1xuICAgICAgbmFtZTogJ3VzZXInLFxuICAgICAgcnVsZXM6IHsgcmVxdWlyZWQ6IHRydWUsIG1lc3NhZ2U6ICfluJDlj7flv4XloasnIH0sXG4gICAgfSwge1xuICAgICAgbmFtZTogJ3B3ZCcsXG4gICAgICBydWxlczogeyByZXF1aXJlZDogdHJ1ZSwgbWVzc2FnZTogJ+WvhueggeW/heWhqycgfSxcbiAgICB9XSxcbiAgICBmb3JtRGF0YToge1xuICAgICAgdXNlcjogXCJcIixcbiAgICAgIHB3ZDogXCJcIlxuICAgIH0sXG4gICAgIG1zZ1Nob3c6IGZhbHNlLFxuICAgICBlcnJvcjogJycsXG4gICAgIGlzQ29tOiBnZXRBcHA8QnBtT3B0aW9uPigpLmdsb2JhbERhdGEuaXNDb20sXG4gIH0sXG4gIC8vIOS6i+S7tuWkhOeQhuWHveaVsFxuICBiaW5kTXNnSGlkZSgpIHtcbiAgIHRoaXMuc2V0RGF0YSh7XG4gICAgbXNnU2hvdyA6IGZhbHNlLFxuICAgfSk7XG4gIH0sXG5cbiAgb25TaG93VXNlcigpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgc2hvd1VzZXJEaWFsb2c6IHRydWVcbiAgICB9KTtcbiAgfSxcblxuICBvblVzZXJDb25maXJtKCkge1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIHRoaXMuc2VsZWN0Q29tcG9uZW50KCcjZm9ybScpLnZhbGlkYXRlKCh2YWxpZDogYW55LCBlcnJvcnM6IGFueSkgPT4ge1xuICAgICAgaWYgKCF2YWxpZCkge1xuICAgICAgICBjb25zdCBmaXJzdEVycm9yID0gT2JqZWN0LmtleXMoZXJyb3JzKVxuICAgICAgICBpZiAoZmlyc3RFcnJvci5sZW5ndGgpIHtcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgZXJyb3I6IGVycm9yc1tmaXJzdEVycm9yWzBdXS5tZXNzYWdlXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qge3VzZXIsIHB3ZCB9ID0gdGhpcy5kYXRhLmZvcm1EYXRhO1xuICAgICAgICB0aGF0LmxvZ2luKHVzZXIscHdkLCB0cnVlKTtcbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIHNldEVycm9yKGVyck1zZzogc3RyaW5nKSB7XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGVycm9yOiBlcnJNc2csXG4gICAgICBtc2dTaG93OiB0cnVlLFxuICAgIH0pO1xuICB9LFxuXG4gIGZvcm1JbnB1dENoYW5nZShlOiBhbnkpIHtcbiAgICBjb25zdCB7IGZpZWxkIH0gPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldFxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBbYGZvcm1EYXRhLiR7ZmllbGR9YF06IGUuZGV0YWlsLnZhbHVlXG4gICAgfSlcbiAgfSxcblxuICBjb21Mb2dpbigpIHtcbiAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICBjb25zdCBhcHAgPSBnZXRBcHA8QnBtT3B0aW9uPigpO1xuICAgIHd4LnF5LmxvZ2luKHtcbiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKHJlczogeyBjb2RlOiBzdHJpbmc7IGVyck1zZzogc3RyaW5nOyB9KSB7XG4gICAgICAgIGlmIChyZXMuY29kZSkge1xuICAgICAgICAgIC8v5Y+R6LW3572R57uc6K+35rGCXG4gICAgICAgICAgd3hSZXF1ZXN0KHtcbiAgICAgICAgICAgIHVybDogXCJodHRwczovL3dlY2hhdC1hcGkuZ3ptcGMuY29tL3YxL2NvbS9jb2RlMlNlc3Npb25cIixcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICBhZ2VudElkOiBhcHAuZ2xvYmFsRGF0YS5hZ2VudElkLFxuICAgICAgICAgICAgICBqc0NvZGU6IHJlcy5jb2RlLFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09IDIwMCkge1xuICAgICAgICAgICAgICBjb25zdCBkYXRhOiBhbnkgPSByZXMuZGF0YTtcbiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0OiBXZWNoYXRNaW5pcHJvZ3JhbUNvbUNvZGUyU2Vzc2lvblJlc3VsdCA9IGRhdGE7XG4gICAgICAgICAgICAgIGlmKHJlc3VsdC5lcnJjb2RlID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2Vzc2lvbkRhdGE6IENvbVNlc3Npb25EYXRhID0geyAuLi5yZXN1bHQgfTsgXG4gICAgICAgICAgICAgICAgYXBwLmdsb2JhbERhdGEuY29tU2Vzc2lvbkRhdGEgPSBzZXNzaW9uRGF0YTtcblxuICAgICAgICAgICAgICAgIC8v5L+d5a2Y5Yiw57yT5a2Y5LitXG4gICAgICAgICAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoQ09OU1RBTlRfU0VTU0lPTkRBVEFfS0VZLCBzZXNzaW9uRGF0YSk7XG5cbiAgICAgICAgICAgICAgICB0aGF0LmxvZ2luKHNlc3Npb25EYXRhLnVzZXJpZCwgXCJtaW1hXCIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcblxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCfnmbvlvZXlpLHotKXvvIEnICsgcmVzLmVyck1zZylcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9LFxuXG4gIGxvZ2luKHVzZXI6IHN0cmluZywgcHdkOiBzdHJpbmcsIGJpbmQ6IGJvb2xlYW4gPSBmYWxzZSkge1xuICAgIGNvbnN0IGFwcCA9IGdldEFwcDxCcG1PcHRpb24+KCk7XG4gICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgd3hSZXF1ZXN0KHtcbiAgICAgIGhlYWRlciA6IHtcbiAgICAgICAgJ2NvbnRlbnQtdHlwZScgOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyxcbiAgICAgIH0sXG4gICAgICB1cmw6IFwiL2xvZ2luXCIsXG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgdXNlcm5hbWU6ICcxMDk3MicsXG4gICAgICAgIHBhc3N3b3JkOiBwd2RcbiAgICAgIH1cbiAgICB9KS50aGVuKChyZXMpID0+IHtcbiAgICAgIGlmKHJlcy5zdGF0dXNDb2RlID09IDIwMCkge1xuICAgICAgICBjb25zdCBkYXRhOmFueSAgPSByZXMuZGF0YTtcbiAgICAgICAgYXBwLnNldEFjY291bnRJbmZvKHVzZXIsIGRhdGEuZGF0YS50b2tlbik7XG4gICAgICAgIHd4LnN3aXRjaFRhYih7dXJsOiBcIi9wYWdlcy9saXN0L2xpc3RcIn0pO1xuXG4gICAgICAgIGlmKGJpbmQgJiYgIWFwcC5nbG9iYWxEYXRhLmlzQ29tKSB7XG4gICAgICAgICAgY29uc3Qgc2Vzc2lvbkRhdGEgPSBhcHAuZ2V0U2Vzc2lvbkNhY2hlKCk7XG4gICAgICAgICAgaWYoc2Vzc2lvbkRhdGEpIHtcbiAgICAgICAgICAgIHd4UmVxdWVzdCh7XG4gICAgICAgICAgICAgIHVybDogXCJodHRwczovL3dlY2hhdC1hcGkuZ3ptcGMuY29tL3YxL3dlY2hhdC9iaW5kT3BlbklkXCIsXG4gICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgdWFjY291bnQ6IHVzZXIsXG4gICAgICAgICAgICAgICAgb3BlbmlkOiBzZXNzaW9uRGF0YS5vcGVuaWRcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkudGhlbigocmVzKSA9PiB7XG4gICAgICAgICAgICAgIGlmKHJlcy5zdGF0dXNDb2RlID09IDIwMCkge1xuICAgICAgICAgICAgICAgIC8vIGNvbnN0IGRhdGE6YW55ICA9IHJlcy5kYXRhO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGF0LnNldEVycm9yKHJlcy5lcnJNc2cpO1xuICAgICAgfVxuICAgIH0pXG4gICAgLmNhdGNoKChyZXM6IFdlY2hhdE1pbmlwcm9ncmFtLkdlbmVyYWxDYWxsYmFja1Jlc3VsdCkgPT4ge1xuICAgICAgdGhhdC5zZXRFcnJvcihyZXMuZXJyTXNnKTtcbiAgICB9KTtcbiAgfSxcblxuICBvbkxvYWQob3B0aW9uOiBhbnkpIHtcbiAgICBjb25zdCB7IGF1dG8gfSA9IG9wdGlvbjtcbiAgICBjb25zdCB7IGFwcCB9ID0gdGhpcztcbiAgICBjb25zdCB0aGF0ID0gdGhpcztcblxuICAgIGlmKCFhcHAuZ2xvYmFsRGF0YS5pc0NvbSkge1xuICAgICAgY29uc3Qgc2Vzc2lvbkRhdGEgPSBhcHAuZ2V0U2Vzc2lvbkNhY2hlKCk7XG4gICAgICBpZihzZXNzaW9uRGF0YSAmJiAhYXV0bykge1xuICAgICAgICB3eFJlcXVlc3Qoe1xuICAgICAgICAgIHVybDogYGh0dHBzOi8vd2VjaGF0LWFwaS5nem1wYy5jb20vdjEvd2VjaGF0L2dldFVhY2NvdW50QnlPcGVuSWQvJHtzZXNzaW9uRGF0YS5vcGVuaWR9YCxcbiAgICAgICAgfSkudGhlbigocmVzKSA9PiB7XG4gICAgICAgICAgaWYocmVzLnN0YXR1c0NvZGUgPT0gMjAwKSB7XG4gICAgICAgICAgICBjb25zdCBkYXRhOmFueSAgPSByZXMuZGF0YTtcbiAgICAgICAgICAgIGlmKGRhdGEgJiYgZGF0YS5lcnJjb2RlID09IDApIHtcbiAgICAgICAgICAgICAgdGhhdC5sb2dpbihkYXRhLnVhY2NvdW50LCBcIm1pbWFcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB3eC5xeS5jaGVja1Nlc3Npb24oe1xuICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbigpe1xuICAgICAgICAgIC8vc2Vzc2lvbl9rZXkg5pyq6L+H5pyf77yM5bm25LiU5Zyo5pys55Sf5ZG95ZGo5pyf5LiA55u05pyJ5pWIXG4gICAgICAgICAgY29uc3Qgc2Vzc2lvbkRhdGEgPSBhcHAuZ2V0Q29tU2Vzc2lvbkNhY2hlKCk7XG4gICAgICAgICAgaWYoc2Vzc2lvbkRhdGEpIHtcbiAgICAgICAgICAgIHRoYXQubG9naW4oc2Vzc2lvbkRhdGEudXNlcmlkLCBcIm1pbWFcIik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoYXQuY29tTG9naW4oKTtcbiAgICAgICAgfSxcbiAgICAgICAgZmFpbDogZnVuY3Rpb24oKXtcbiAgICAgICAgICAvLyBzZXNzaW9uX2tleSDlt7Lnu4/lpLHmlYjvvIzpnIDopoHph43mlrDmiafooYznmbvlvZXmtYHnqItcbiAgICAgICAgICB0aGF0LmNvbUxvZ2luKCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9LFxuICBnZXRVc2VySW5mbyhlOiBhbnkpIHtcbiAgICBjb25zdCBhcHAgPSBnZXRBcHA8QnBtT3B0aW9uPigpO1xuICAgIGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvID0gZS5kZXRhaWwudXNlckluZm87XG4gICAgdGhpcy5vblVzZXJDb25maXJtKCk7XG4gIH0sXG4gIGdldFBob25lTnVtYmVyKGU6IGFueSkge1xuICAgIGNvbnN0IHsgYXBwIH0gPSB0aGlzO1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIHd4LmNoZWNrU2Vzc2lvbih7XG4gICAgICBzdWNjZXNzOiBmdW5jdGlvbiAocmVzKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XG4gICAgICAgIHZhciBlbmN5ID0gZS5kZXRhaWwuZW5jcnlwdGVkRGF0YTtcbiAgICAgICAgdmFyIGl2ID0gZS5kZXRhaWwuaXY7XG4gICAgICAgIHZhciBzZXNzaW9uayA9IHRoYXQuZGF0YS5zZXNzaW9uS2V5O1xuICAgICAgICBjb25zb2xlLmxvZygnc2Vzc2lvbiBkYXRhOiAnLCBlLCBlbmN5LCBpdiwgc2Vzc2lvbmspO1xuICAgICAgICBjb25zdCBlcnJNc2c6c3RyaW5nID0gZS5kZXRhaWwuZXJyTXNnO1xuICAgICAgICBpZiAoZXJyTXNnICYmIGVyck1zZy5zdGFydHNXaXRoKCdnZXRQaG9uZU51bWJlcjpmYWlsJykpIHtcbiAgICAgICAgICB0aGF0LnNldERhdGEoe1xuICAgICAgICAgICAgbW9kYWxzdGF0dXM6IHRydWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHsgLy/lkIzmhI/mjojmnYNcbiAgICAgICAgICBjb25zdCBwYyA9IG5ldyBXWEJpekRhdGFDcnlwdChhcHAuZ2xvYmFsRGF0YS5hcHBJZCwgc2Vzc2lvbmspO1xuXG4gICAgICAgICAgdmFyIGRhdGEgPSBwYy5kZWNyeXB0RGF0YShlbmN5ICwgaXYpXG4gICAgICAgICAgY29uc29sZS5sb2coJ+ino+WvhuWQjiBkYXRhOiAnLCBkYXRhKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgZmFpbDogZnVuY3Rpb24gKCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcInNlc3Npb25fa2V5IOW3sue7j+WkseaViO+8jOmcgOimgemHjeaWsOaJp+ihjOeZu+W9lea1geeoi1wiKTtcbiAgICAgICAgLy8gdGhhdC53eGxvZ2luKCk7IC8v6YeN5paw55m75b2VXG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn0pXG4iXX0=