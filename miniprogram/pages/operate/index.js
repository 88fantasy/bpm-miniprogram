import { approve, stop, reject, abolish, reply, sign } from '../../services/assapi';
Page({
    app: getApp(),
    data: {
        comment: '',
        oper: '',
        node: '',
        rowData: {
            id: '',
            categoryid: '',
            isNeedApprover: 0,
        },
        msgShow: false,
        msgInfo: {
            type: '',
            title: '',
            desc: '',
        }
    },
    onAppendComment(e) {
        const { dataset: { text } } = e.target;
        const { comment } = this.data;
        const newComment = comment.concat(text);
        this.setData({
            comment: newComment,
        });
    },
    onNodeChange(event) {
        this.setData({
            node: event.detail,
        });
    },
    onRadioClick(event) {
        const { name } = event.currentTarget.dataset;
        this.setData({
            node: name,
        });
    },
    onApproveClick() {
        const that = this;
        const { rowData, comment, node } = that.data;
        if (rowData) {
            if (rowData.isNeedApprover === 1) {
                that.operateFail({
                    message: '暂时不支持选人',
                });
            }
            else {
                const request = {
                    approvalId: rowData.id,
                    categoryid: rowData.categoryid,
                    comment: `${comment} (来自:微信小程序)`,
                };
                if (node && node !== '') {
                    Object.assign(request, {
                        nextNode: node
                    });
                }
                approve(request).then(that.operateSuccess)
                    .catch(that.operateFail);
            }
        }
    },
    onRejectClick() {
        const that = this;
        const { rowData, comment, node } = that.data;
        if (rowData) {
            const request = {
                approvalId: rowData.id,
                categoryid: rowData.categoryid,
                comment: `${comment} (来自:微信小程序)`,
            };
            if (node && node !== '') {
                Object.assign(request, {
                    rejectNode: node
                });
            }
            reject(request).then(that.operateSuccess)
                .catch(that.operateFail);
        }
    },
    onStopClick() {
        const that = this;
        const { rowData, comment, } = that.data;
        if (rowData) {
            stop({
                approvalId: rowData.id,
                categoryid: rowData.categoryid,
                comment: `${comment} (来自:微信小程序)`,
            }).then(that.operateSuccess)
                .catch(that.operateFail);
        }
    },
    onSignClick() {
        const that = this;
        const { rowData, comment, } = that.data;
        if (rowData) {
            sign({
                approvalId: rowData.id,
                comment: `${comment} (来自:微信小程序)`,
            }).then(that.operateSuccess)
                .catch(that.operateFail);
        }
    },
    onAbolishClick() {
        const that = this;
        const { rowData, comment, } = that.data;
        if (rowData) {
            abolish({
                approvalId: rowData.id,
                comment: `${comment} (来自:微信小程序)`,
            }).then(that.operateSuccess)
                .catch(that.operateFail);
        }
    },
    onReplyClick() {
        const that = this;
        const { rowData, comment, } = that.data;
        if (rowData) {
            reply({
                approvalId: rowData.id,
                comment: `${comment} (来自:微信小程序)`,
            }).then(that.operateSuccess)
                .catch(that.operateFail);
        }
    },
    operateSuccess(res) {
        const data = res.data;
        if (res.statusCode === 200) {
            if (data.status == 200) {
                wx.navigateBack({
                    delta: 2,
                });
            }
            else {
                this.operateFail({
                    message: data.errorMessage,
                });
            }
        }
        else {
            this.operateFail({
                message: data.message,
            });
        }
    },
    operateFail(res) {
        this.setData({
            msgShow: true,
            msgInfo: {
                type: 'error',
                title: '操作失败',
                desc: res.message,
            },
        });
    },
    bindMsgHide() {
        this.setData({
            msgShow: false,
        });
    },
    onLoad: function () {
        const that = this;
        const eventChannel = this.getOpenerEventChannel();
        eventChannel.on('acceptDataFromOpenerPage', function (data) {
            const { rowData, oper } = data;
            let node = '';
            if (oper === 'approve') {
                node = rowData && rowData.nextNode && rowData.nextNode.length > 0 ? rowData.nextNode[0].id : '';
            }
            else if (oper === 'reject') {
                node = rowData && rowData.rejectNode && rowData.rejectNode.length > 0 ? rowData.rejectNode[0].id : '';
            }
            that.setData({
                rowData,
                oper,
                node,
            });
        });
    },
    onReady: function () {
    },
    onShow: function () {
    },
    onHide: function () {
    },
    onUnload: function () {
    },
    onPullDownRefresh: function () {
    },
    onReachBottom: function () {
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUVwRixJQUFJLENBQUM7SUFDSCxHQUFHLEVBQUUsTUFBTSxFQUFhO0lBSXhCLElBQUksRUFBRTtRQUNKLE9BQU8sRUFBRSxFQUFFO1FBQ1gsSUFBSSxFQUFFLEVBQUU7UUFDUixJQUFJLEVBQUUsRUFBRTtRQUNSLE9BQU8sRUFBRTtZQUNQLEVBQUUsRUFBRSxFQUFFO1lBQ04sVUFBVSxFQUFFLEVBQUU7WUFDZCxjQUFjLEVBQUUsQ0FBQztTQUNsQjtRQUNELE9BQU8sRUFBRSxLQUFLO1FBQ2QsT0FBTyxFQUFFO1lBQ1AsSUFBSSxFQUFFLEVBQUU7WUFDUixLQUFLLEVBQUUsRUFBRTtZQUNULElBQUksRUFBRSxFQUFFO1NBQ1Q7S0FDRjtJQUVELGVBQWUsQ0FBQyxDQUFNO1FBQ3BCLE1BQU0sRUFBRSxPQUFPLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxHQUl2QixDQUFDLENBQUMsTUFBTSxDQUFDO1FBRWIsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDOUIsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsT0FBTyxFQUFFLFVBQVU7U0FDcEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFlBQVksQ0FBQyxLQUFVO1FBQ3JCLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxJQUFJLEVBQUUsS0FBSyxDQUFDLE1BQU07U0FDbkIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFlBQVksQ0FBQyxLQUFVO1FBQ3JCLE1BQU0sRUFBRSxJQUFJ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ekIsSUFBSSxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBVSxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQzthQUN2RztZQUNELElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsT0FBTztnQkFDUCxJQUFJO2dCQUNKLElBQUk7YUFDTCxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFLRCxPQUFPLEVBQUU7SUFFVCxDQUFDO0lBS0QsTUFBTSxFQUFFO0lBRVIsQ0FBQztJQUtELE1BQU0sRUFBRTtJQUVSLENBQUM7SUFLRCxRQUFRLEVBQUU7SUFFVixDQUFDO0lBS0QsaUJBQWlCLEVBQUU7SUFFbkIsQ0FBQztJQUtELGFBQWEsRUFBRTtJQUVmLENBQUM7Q0FDRixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vIGltcG9ydCB7IHd4UmVxdWVzdCB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3JlcXVlc3QnO1xuaW1wb3J0IHsgYXBwcm92ZSwgc3RvcCwgcmVqZWN0LCBhYm9saXNoLCByZXBseSwgc2lnbiB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2Fzc2FwaSc7XG5cblBhZ2Uoe1xuICBhcHA6IGdldEFwcDxCcG1PcHRpb24+KCksXG4gIC8qKlxuICAgKiDpobXpnaLnmoTliJ3lp4vmlbDmja5cbiAgICovXG4gIGRhdGE6IHtcbiAgICBjb21tZW50OiAnJyxcbiAgICBvcGVyOiAnJyxcbiAgICBub2RlOiAnJyxcbiAgICByb3dEYXRhOiB7XG4gICAgICBpZDogJycsXG4gICAgICBjYXRlZ29yeWlkOiAnJyxcbiAgICAgIGlzTmVlZEFwcHJvdmVyOiAwLFxuICAgIH0sXG4gICAgbXNnU2hvdzogZmFsc2UsXG4gICAgbXNnSW5mbzoge1xuICAgICAgdHlwZTogJycsXG4gICAgICB0aXRsZTogJycsXG4gICAgICBkZXNjOiAnJyxcbiAgICB9XG4gIH0sXG5cbiAgb25BcHBlbmRDb21tZW50KGU6IGFueSkge1xuICAgIGNvbnN0IHsgZGF0YXNldDogeyB0ZXh0IH0gfToge1xuICAgICAgZGF0YXNldDoge1xuICAgICAgICB0ZXh0OiBzdHJpbmc7XG4gICAgICB9XG4gICAgfSA9IGUudGFyZ2V0O1xuXG4gICAgY29uc3QgeyBjb21tZW50IH0gPSB0aGlzLmRhdGE7XG4gICAgY29uc3QgbmV3Q29tbWVudCA9IGNvbW1lbnQuY29uY2F0KHRleHQpO1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBjb21tZW50OiBuZXdDb21tZW50LFxuICAgIH0pO1xuICB9LFxuXG4gIG9uTm9kZUNoYW5nZShldmVudDogYW55KSB7XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIG5vZGU6IGV2ZW50LmRldGFpbCxcbiAgICB9KTtcbiAgfSxcblxuICBvblJhZGlvQ2xpY2soZXZlbnQ6IGFueSkge1xuICAgIGNvbnN0IHsgbmFtZSB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBub2RlOiBuYW1lLFxuICAgIH0pO1xuICB9LFxuXG5cbiAgb25BcHByb3ZlQ2xpY2soKSB7XG4gICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgLy8gY29uc3QgeyByb3dEYXRhLCBjb21tZW50LCBvcGVyIH0gPSB0aGF0LmRhdGE7XG4gICAgY29uc3QgeyByb3dEYXRhLCBjb21tZW50LCBub2RlfSA9IHRoYXQuZGF0YVxuXG4gICAgaWYgKHJvd0RhdGEpIHtcbiAgICAgIGlmKHJvd0RhdGEuaXNOZWVkQXBwcm92ZXIgPT09IDEpIHtcbiAgICAgICAgdGhhdC5vcGVyYXRlRmFpbCh7XG4gICAgICAgICAgbWVzc2FnZTogJ+aaguaXtuS4jeaUr+aMgemAieS6uicsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3Q6IEFwcHJvdmVSZXF1ZXN0ID0ge1xuICAgICAgICAgIGFwcHJvdmFsSWQ6IHJvd0RhdGEuaWQsXG4gICAgICAgICAgY2F0ZWdvcnlpZDogcm93RGF0YS5jYXRlZ29yeWlkLFxuICAgICAgICAgIGNvbW1lbnQ6IGAke2NvbW1lbnR9ICjmnaXoh6o65b6u5L+h5bCP56iL5bqPKWAsXG4gICAgICAgIH07XG4gICAgICAgIGlmKG5vZGUgJiYgbm9kZSAhPT0gJycpIHtcbiAgICAgICAgICBPYmplY3QuYXNzaWduKHJlcXVlc3QsIHtcbiAgICAgICAgICAgIG5leHROb2RlOiBub2RlXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgYXBwcm92ZShyZXF1ZXN0KS50aGVuKHRoYXQub3BlcmF0ZVN1Y2Nlc3MpXG4gICAgICAgICAgLmNhdGNoKHRoYXQub3BlcmF0ZUZhaWwpO1xuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBvblJlamVjdENsaWNrKCkge1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIGNvbnN0IHsgcm93RGF0YSwgY29tbWVudCwgbm9kZX0gPSB0aGF0LmRhdGE7XG5cbiAgICBpZiAocm93RGF0YSkge1xuICAgICAgY29uc3QgcmVxdWVzdDogUmVqZWN0UmVxdWVzdCA9IHtcbiAgICAgICAgYXBwcm92YWxJZDogcm93RGF0YS5pZCxcbiAgICAgICAgY2F0ZWdvcnlpZDogcm93RGF0YS5jYXRlZ29yeWlkLFxuICAgICAgICBjb21tZW50OiBgJHtjb21tZW50fSAo5p2l6IeqOuW+ruS/oeWwj+eoi+W6jylgLFxuICAgICAgfTtcbiAgICAgIGlmKG5vZGUgJiYgbm9kZSAhPT0gJycpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihyZXF1ZXN0LCB7XG4gICAgICAgICAgcmVqZWN0Tm9kZTogbm9kZVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHJlamVjdChyZXF1ZXN0KS50aGVuKHRoYXQub3BlcmF0ZVN1Y2Nlc3MpXG4gICAgICAgIC5jYXRjaCh0aGF0Lm9wZXJhdGVGYWlsKTtcbiAgICB9XG4gIH0sXG5cbiAgb25TdG9wQ2xpY2soKSB7XG4gICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgY29uc3QgeyByb3dEYXRhLCBjb21tZW50LCB9ID0gdGhhdC5kYXRhO1xuXG4gICAgaWYgKHJvd0RhdGEpIHtcbiAgICAgIHN0b3Aoe1xuICAgICAgICBhcHByb3ZhbElkOiByb3dEYXRhLmlkLFxuICAgICAgICBjYXRlZ29yeWlkOiByb3dEYXRhLmNhdGVnb3J5aWQsXG4gICAgICAgIGNvbW1lbnQ6IGAke2NvbW1lbnR9ICjmnaXoh6o65b6u5L+h5bCP56iL5bqPKWAsXG4gICAgICB9KS50aGVuKHRoYXQub3BlcmF0ZVN1Y2Nlc3MpXG4gICAgICAgIC5jYXRjaCh0aGF0Lm9wZXJhdGVGYWlsKTtcbiAgICB9XG4gIH0sXG5cbiAgb25TaWduQ2xpY2soKSB7XG4gICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgY29uc3QgeyByb3dEYXRhLCBjb21tZW50LCB9ID0gdGhhdC5kYXRhO1xuXG4gICAgaWYgKHJvd0RhdGEpIHtcbiAgICAgIHNpZ24oe1xuICAgICAgICBhcHByb3ZhbElkOiByb3dEYXRhLmlkLFxuICAgICAgICBjb21tZW50OiBgJHtjb21tZW50fSAo5p2l6IeqOuW+ruS/oeWwj+eoi+W6jylgLFxuICAgICAgfSkudGhlbih0aGF0Lm9wZXJhdGVTdWNjZXNzKVxuICAgICAgICAuY2F0Y2godGhhdC5vcGVyYXRlRmFpbCk7XG4gICAgfVxuICB9LFxuXG4gIG9uQWJvbGlzaENsaWNrKCkge1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIGNvbnN0IHsgcm93RGF0YSwgY29tbWVudCwgfSA9IHRoYXQuZGF0YTtcblxuICAgIGlmIChyb3dEYXRhKSB7XG4gICAgICBhYm9saXNoKHtcbiAgICAgICAgYXBwcm92YWxJZDogcm93RGF0YS5pZCxcbiAgICAgICAgY29tbWVudDogYCR7Y29tbWVudH0gKOadpeiHqjrlvq7kv6HlsI/nqIvluo8pYCxcbiAgICAgIH0pLnRoZW4odGhhdC5vcGVyYXRlU3VjY2VzcylcbiAgICAgICAgLmNhdGNoKHRoYXQub3BlcmF0ZUZhaWwpO1xuICAgIH1cbiAgfSxcblxuICBvblJlcGx5Q2xpY2soKSB7XG4gICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgY29uc3QgeyByb3dEYXRhLCBjb21tZW50LCB9ID0gdGhhdC5kYXRhO1xuXG4gICAgaWYgKHJvd0RhdGEpIHtcbiAgICAgIHJlcGx5KHtcbiAgICAgICAgYXBwcm92YWxJZDogcm93RGF0YS5pZCxcbiAgICAgICAgY29tbWVudDogYCR7Y29tbWVudH0gKOadpeiHqjrlvq7kv6HlsI/nqIvluo8pYCxcbiAgICAgIH0pLnRoZW4odGhhdC5vcGVyYXRlU3VjY2VzcylcbiAgICAgICAgLmNhdGNoKHRoYXQub3BlcmF0ZUZhaWwpO1xuICAgIH1cbiAgfSxcblxuICBvcGVyYXRlU3VjY2VzcyhyZXM6IFdlY2hhdE1pbmlwcm9ncmFtLlJlcXVlc3RTdWNjZXNzQ2FsbGJhY2tSZXN1bHQpIHtcbiAgICBjb25zdCBkYXRhOiBhbnkgPSByZXMuZGF0YTtcbiAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgaWYgKGRhdGEuc3RhdHVzID09IDIwMCkge1xuICAgICAgICB3eC5uYXZpZ2F0ZUJhY2soe1xuICAgICAgICAgIGRlbHRhOiAyLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLm9wZXJhdGVGYWlsKHtcbiAgICAgICAgICBtZXNzYWdlOiBkYXRhLmVycm9yTWVzc2FnZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgdGhpcy5vcGVyYXRlRmFpbCh7XG4gICAgICAgIG1lc3NhZ2U6IGRhdGEubWVzc2FnZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcblxuICBvcGVyYXRlRmFpbChyZXM6IGFueSkge1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBtc2dTaG93OiB0cnVlLFxuICAgICAgbXNnSW5mbzoge1xuICAgICAgICB0eXBlOiAnZXJyb3InLFxuICAgICAgICB0aXRsZTogJ+aTjeS9nOWksei0pScsXG4gICAgICAgIGRlc2M6IHJlcy5tZXNzYWdlLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSxcblxuICBiaW5kTXNnSGlkZSgpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgbXNnU2hvdzogZmFsc2UsXG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yqg6L29XG4gICAqL1xuICBvbkxvYWQ6IGZ1bmN0aW9uICgpIHtcbiAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICBjb25zdCBldmVudENoYW5uZWwgPSB0aGlzLmdldE9wZW5lckV2ZW50Q2hhbm5lbCgpO1xuICAgIC8vIOebkeWQrGFjY2VwdERhdGFGcm9tT3BlbmVyUGFnZeS6i+S7tu+8jOiOt+WPluS4iuS4gOmhtemdoumAmui/h2V2ZW50Q2hhbm5lbOS8oOmAgeWIsOW9k+WJjemhtemdoueahOaVsOaNrlxuICAgIGV2ZW50Q2hhbm5lbC5vbignYWNjZXB0RGF0YUZyb21PcGVuZXJQYWdlJywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgIGNvbnN0IHsgcm93RGF0YSwgb3BlciB9OiB7IHJvd0RhdGE6IGFueTsgb3Blcjogc3RyaW5nOyB9ID0gZGF0YTtcbiAgICAgIGxldCBub2RlID0nJztcbiAgICAgIGlmKG9wZXIgPT09ICdhcHByb3ZlJykge1xuICAgICAgICBub2RlID0gcm93RGF0YSAmJiByb3dEYXRhLm5leHROb2RlICYmIHJvd0RhdGEubmV4dE5vZGUubGVuZ3RoID4gMCA/IHJvd0RhdGEubmV4dE5vZGVbMF0uaWQgOiAnJztcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYob3BlciA9PT0gJ3JlamVjdCcpIHtcbiAgICAgICAgbm9kZSA9IHJvd0RhdGEgJiYgcm93RGF0YS5yZWplY3ROb2RlICYmIHJvd0RhdGEucmVqZWN0Tm9kZS5sZW5ndGggPiAwID8gcm93RGF0YS5yZWplY3ROb2RlWzBdLmlkIDogJyc7XG4gICAgICB9XG4gICAgICB0aGF0LnNldERhdGEoe1xuICAgICAgICByb3dEYXRhLFxuICAgICAgICBvcGVyLFxuICAgICAgICBub2RlLFxuICAgICAgfSk7XG4gICAgfSlcbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliJ3mrKHmuLLmn5PlrozmiJBcbiAgICovXG4gIG9uUmVhZHk6IGZ1bmN0aW9uICgpIHtcblxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouaYvuekulxuICAgKi9cbiAgb25TaG93OiBmdW5jdGlvbiAoKSB7XG5cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLpmpDol49cbiAgICovXG4gIG9uSGlkZTogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Y246L29XG4gICAqL1xuICBvblVubG9hZDogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIOmhtemdouebuOWFs+S6i+S7tuWkhOeQhuWHveaVsC0t55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXG4gICAqL1xuICBvblB1bGxEb3duUmVmcmVzaDogZnVuY3Rpb24gKCkge1xuXG4gIH0sXG5cbiAgLyoqXG4gICAqIOmhtemdouS4iuaLieinpuW6leS6i+S7tueahOWkhOeQhuWHveaVsFxuICAgKi9cbiAgb25SZWFjaEJvdHRvbTogZnVuY3Rpb24gKCkge1xuXG4gIH1cbn0pOyJdfQ==