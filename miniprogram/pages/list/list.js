import { wxRequest } from '../../utils/request';
import { approve, stop } from '../../services/assapi';
Page({
    app: getApp(),
    data: {
        error: '',
        assList: []
    },
    setError(errMsg) {
        this.setData({
            error: errMsg
        });
    },
    onRefreshData() {
        const { app } = this;
        const { token } = app.globalData.accountInfo;
        const that = this;
        wxRequest({
            url: "/ass/asslist/" + token,
        }).then((res) => {
            wx.hideLoading();
            if (res.statusCode == 200) {
                const data = res.data;
                that.setData({
                    assList: data.data
                });
            }
            else {
                that.setError(res.errMsg);
            }
        })
            .catch((res) => {
            that.setError(res.errMsg);
        });
    },
    onCellClick(e) {
        const that = this;
        const { dataset: { id } } = e.target;
        const row = this.searchRow(id);
        if (row) {
            wx.navigateTo({
                url: '/pages/detail/index',
                events: {
                    detailBack: function (data) {
                        const { id, promise } = data;
                        that.updateRow(data.id, {
                            loading: true,
                        });
                        promise.then((res) => {
                            that.onOperateSuccess(id, res);
                        }).catch((res) => {
                            that.onOperateFail(id, res);
                        });
                    }
                },
                success: function (res) {
                    res.eventChannel.emit('acceptDataFromOpenerPage', {
                        approvalid: id,
                        rowData: row,
                    });
                }
            });
        }
    },
    onOperateSuccess(id, res) {
        const data = res.data;
        if (res.statusCode === 200) {
            if (data.status == 200) {
                this.removeRow(id);
            }
            else {
                this.updateRow(id, {
                    error: String(data.errorMessage),
                    loading: false,
                });
            }
        }
        else {
            this.updateRow(id, {
                error: String(data.message),
                loading: false,
            });
        }
    },
    onOperateFail(id, res) {
        this.updateRow(id, {
            error: String(res.message),
            loading: false,
        });
    },
    onStopClick(e) {
        const { dataset: { id } } = e.target;
        const that = this;
        const row = that.searchRow(id);
        if (row) {
            that.updateRow(id, {
                loading: true,
            });
            stop({
                approvalId: row.id,
                categoryid: row.categoryid,
                comment: '快速中止 (来自:微信小程序)',
            }).then((res) => {
                that.onOperateSuccess(id, res);
            }).catch((res) => {
                that.onOperateFail(id, res);
            });
        }
    },
    onApproveClick(e) {
        const { dataset: { id } } = e.target;
        const that = this;
        const row = that.searchRow(id);
        if (row) {
            that.updateRow(id, {
                loading: true,
            });
            approve({
                approvalId: row.id,
                categoryid: row.categoryid,
                comment: '快速同意 (来自:微信小程序)',
            }).then((res) => {
                that.onOperateSuccess(id, res);
            }).catch((res) => {
                that.onOperateFail(id, res);
            });
        }
    },
    searchRow(id) {
        const { assList } = this.data;
        if (assList) {
            return assList.find((item) => item.id === id);
        }
        else {
            return undefined;
        }
    },
    updateRow(id, fields) {
        const { assList } = this.data;
        assList.map((item) => {
            if (item.id == id) {
                Object.assign(item, {
                    ...fields,
                });
            }
        });
        this.setData({
            assList,
        });
    },
    removeRow(id) {
        const { assList } = this.data;
        const newList = assList.filter((item) => item.id !== id);
        this.setData({
            assList: newList,
        });
    },
    onLoad() {
    },
    onShow() {
        this.onRefreshData();
    },
    onPullDownRefresh() {
        this.onRefreshData();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFdEQsSUFBSSxDQUFDO0lBQ0gsR0FBRyxFQUFFLE1BQU0sRUFBYTtJQUN4QixJQUFJLEVBQUU7UUFDSixLQUFLLEVBQUUsRUFBRTtRQUNULE9BQU8sRUFBRSxFQUFFO0tBQ1o7SUFFRCxRQUFRLENBQUMsTUFBYztRQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsS0FBSyxFQUFFLE1BQU07U0FDZCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsYUFBYTtRQUNYLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDckIsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDO1FBQzdDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixTQUFTLENBQUM7WUFDUixHQUFHLEVBQUUsZUFBZSxHQUFHLEtBQUs7U0FDN0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2QsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2pCLElBQUksR0FBRyxDQUFDLFVBQVUsSUFBSSxHQUFHLEVBQUU7Z0JBQ3pCLE1BQU0sSUFBSSxHQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1gsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJO2lCQUNuQixDQUFDLENBQUE7YUFDSDtpQkFDSTtnQkFDSCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQzthQUMzQjtRQUNILENBQUMsQ0FBQzthQUNDLEtBQUssQ0FBQyxD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QztJQUVELE1BQU07SUFJTixDQUFDO0lBRUQsTUFBTTtRQUNKLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBRUQsaUJBQWlCO1FBQ2YsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7Q0FFRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBsaXN0LnRzXG5pbXBvcnQgeyB3eFJlcXVlc3QgfSBmcm9tICcuLi8uLi91dGlscy9yZXF1ZXN0JztcbmltcG9ydCB7IGFwcHJvdmUsIHN0b3AgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hc3NhcGknO1xuXG5QYWdlKHtcbiAgYXBwOiBnZXRBcHA8QnBtT3B0aW9uPigpLFxuICBkYXRhOiB7XG4gICAgZXJyb3I6ICcnLFxuICAgIGFzc0xpc3Q6IFtdXG4gIH0sXG5cbiAgc2V0RXJyb3IoZXJyTXNnOiBzdHJpbmcpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZXJyb3I6IGVyck1zZ1xuICAgIH0pO1xuICB9LFxuXG4gIG9uUmVmcmVzaERhdGEoKSB7XG4gICAgY29uc3QgeyBhcHAgfSA9IHRoaXM7XG4gICAgY29uc3QgeyB0b2tlbiB9ID0gYXBwLmdsb2JhbERhdGEuYWNjb3VudEluZm87XG4gICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgd3hSZXF1ZXN0KHtcbiAgICAgIHVybDogXCIvYXNzL2Fzc2xpc3QvXCIgKyB0b2tlbixcbiAgICB9KS50aGVuKChyZXMpID0+IHtcbiAgICAgIHd4LmhpZGVMb2FkaW5nKCk7XG4gICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IGRhdGE6IGFueSA9IHJlcy5kYXRhO1xuICAgICAgICB0aGF0LnNldERhdGEoe1xuICAgICAgICAgIGFzc0xpc3Q6IGRhdGEuZGF0YVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHRoYXQuc2V0RXJyb3IocmVzLmVyck1zZyk7XG4gICAgICB9XG4gICAgfSlcbiAgICAgIC5jYXRjaCgocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5HZW5lcmFsQ2FsbGJhY2tSZXN1bHQpID0+IHtcbiAgICAgICAgdGhhdC5zZXRFcnJvcihyZXMuZXJyTXNnKTtcbiAgICAgIH0pO1xuICB9LFxuXG4gIG9uQ2VsbENsaWNrKGU6IGFueSkge1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIGNvbnN0IHsgZGF0YXNldDogeyBpZCB9IH0gPSBlLnRhcmdldDtcbiAgICBjb25zdCByb3cgPSB0aGlzLnNlYXJjaFJvdyhpZCk7XG4gICAgaWYocm93KSB7XG4gICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgdXJsOiAnL3BhZ2VzL2RldGFpbC9pbmRleCcsXG4gICAgICAgIGV2ZW50czoge1xuICAgICAgICAgIC8vIOS4uuaMh+WumuS6i+S7tua3u+WKoOS4gOS4quebkeWQrOWZqO+8jOiOt+WPluiiq+aJk+W8gOmhtemdouS8oOmAgeWIsOW9k+WJjemhtemdoueahOaVsOaNrlxuICAgICAgICAgIGRldGFpbEJhY2s6IGZ1bmN0aW9uKGRhdGE6IHtcbiAgICAgICAgICAgIGlkOiBzdHJpbmc7XG4gICAgICAgICAgICBwcm9taXNlOiBQcm9taXNlPFdlY2hhdE1pbmlwcm9ncmFtLlJlcXVlc3RTdWNjZXNzQ2FsbGJhY2tSZXN1bHQ+O1xuICAgICAgICAgIH0pIHtcbiAgICAgICAgICAgIGNvbnN0IHsgaWQsIHByb21pc2UgfSA9IGRhdGE7XG4gICAgICAgICAgICB0aGF0LnVwZGF0ZVJvdyhkYXRhLmlkLCB7XG4gICAgICAgICAgICAgIGxvYWRpbmc6IHRydWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHByb21pc2UudGhlbigocmVzOiBXZWNoYXRNaW5pcHJvZ3JhbS5SZXF1ZXN0U3VjY2Vzc0NhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgIHRoYXQub25PcGVyYXRlU3VjY2VzcyhpZCxyZXMpO1xuICAgICAgICAgICAgfSkuY2F0Y2goKHJlczogYW55KSA9PiB7XG4gICAgICAgICAgICAgIHRoYXQub25PcGVyYXRlRmFpbChpZCxyZXMpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAocmVzKSB7XG4gICAgICAgICAgLy8g6YCa6L+HZXZlbnRDaGFubmVs5ZCR6KKr5omT5byA6aG16Z2i5Lyg6YCB5pWw5o2uXG4gICAgICAgICAgcmVzLmV2ZW50Q2hhbm5lbC5lbWl0KCdhY2NlcHREYXRhRnJvbU9wZW5lclBhZ2UnLCB7XG4gICAgICAgICAgICBhcHByb3ZhbGlkOiBpZCxcbiAgICAgICAgICAgIHJvd0RhdGE6IHJvdyxcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgb25PcGVyYXRlU3VjY2VzcyhpZDogc3RyaW5nLCByZXM6IFdlY2hhdE1pbmlwcm9ncmFtLlJlcXVlc3RTdWNjZXNzQ2FsbGJhY2tSZXN1bHQpIHtcbiAgICBjb25zdCBkYXRhOiBhbnkgPSByZXMuZGF0YTtcbiAgICBpZihyZXMuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICBpZihkYXRhLnN0YXR1cyA9PSAyMDApIHtcbiAgICAgICAgdGhpcy5yZW1vdmVSb3coaWQpO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIHRoaXMudXBkYXRlUm93KGlkLCB7XG4gICAgICAgICAgZXJyb3I6IFN0cmluZyhkYXRhLmVycm9yTWVzc2FnZSksXG4gICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHRoaXMudXBkYXRlUm93KGlkLCB7XG4gICAgICAgIGVycm9yOiBTdHJpbmcoZGF0YS5tZXNzYWdlKSxcbiAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgb25PcGVyYXRlRmFpbChpZDogc3RyaW5nLCByZXM6IGFueSkge1xuICAgIHRoaXMudXBkYXRlUm93KGlkLCB7XG4gICAgICBlcnJvcjogU3RyaW5nKHJlcy5tZXNzYWdlKSxcbiAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgIH0pO1xuICB9LFxuXG4gIG9uU3RvcENsaWNrKGU6IGFueSkge1xuICAgIGNvbnN0IHsgZGF0YXNldDogeyBpZCB9IH0gPSBlLnRhcmdldDtcbiAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICBjb25zdCByb3c6IGFueSA9IHRoYXQuc2VhcmNoUm93KGlkKTtcblxuICAgIGlmIChyb3cpIHtcbiAgICAgIHRoYXQudXBkYXRlUm93KGlkLCB7XG4gICAgICAgIGxvYWRpbmc6IHRydWUsXG4gICAgICB9KTtcbiAgICAgIHN0b3Aoe1xuICAgICAgICBhcHByb3ZhbElkOiByb3cuaWQsXG4gICAgICAgIGNhdGVnb3J5aWQ6IHJvdy5jYXRlZ29yeWlkLFxuICAgICAgICBjb21tZW50OiAn5b+r6YCf5Lit5q2iICjmnaXoh6o65b6u5L+h5bCP56iL5bqPKScsXG4gICAgICB9KS50aGVuKChyZXMpID0+IHtcbiAgICAgICAgdGhhdC5vbk9wZXJhdGVTdWNjZXNzKGlkLHJlcyk7XG4gICAgICB9KS5jYXRjaCgocmVzKSA9PiB7XG4gICAgICAgIHRoYXQub25PcGVyYXRlRmFpbChpZCxyZXMpO1xuICAgICAgfSk7XG4gICAgfVxuICB9LFxuXG4gIG9uQXBwcm92ZUNsaWNrKGU6IGFueSkge1xuICAgIGNvbnN0IHsgZGF0YXNldDogeyBpZCB9IH0gPSBlLnRhcmdldDtcbiAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICBjb25zdCByb3c6IGFueSA9IHRoYXQuc2VhcmNoUm93KGlkKTtcblxuICAgIGlmIChyb3cpIHtcbiAgICAgIHRoYXQudXBkYXRlUm93KGlkLCB7XG4gICAgICAgIGxvYWRpbmc6IHRydWUsXG4gICAgICB9KTtcbiAgICAgIGFwcHJvdmUoe1xuICAgICAgICBhcHByb3ZhbElkOiByb3cuaWQsXG4gICAgICAgIGNhdGVnb3J5aWQ6IHJvdy5jYXRlZ29yeWlkLFxuICAgICAgICBjb21tZW50OiAn5b+r6YCf5ZCM5oSPICjmnaXoh6o65b6u5L+h5bCP56iL5bqPKScsXG4gICAgICB9KS50aGVuKChyZXMpID0+IHtcbiAgICAgICAgdGhhdC5vbk9wZXJhdGVTdWNjZXNzKGlkLHJlcyk7XG4gICAgICB9KS5jYXRjaCgocmVzKSA9PiB7XG4gICAgICAgIHRoYXQub25PcGVyYXRlRmFpbChpZCxyZXMpO1xuICAgICAgfSk7XG4gICAgfVxuICB9LFxuXG4gIHNlYXJjaFJvdyhpZDogc3RyaW5nKSB7XG4gICAgY29uc3QgeyBhc3NMaXN0IH0gPSB0aGlzLmRhdGE7XG4gICAgaWYgKGFzc0xpc3QpIHtcbiAgICAgIHJldHVybiBhc3NMaXN0LmZpbmQoKGl0ZW06IGFueSkgPT4gaXRlbS5pZCA9PT0gaWQpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9LFxuXG4gIHVwZGF0ZVJvdyhpZDogc3RyaW5nLCBmaWVsZHM6IGFueSkge1xuICAgIGNvbnN0IHsgYXNzTGlzdCB9ID0gdGhpcy5kYXRhO1xuICAgIGFzc0xpc3QubWFwKChpdGVtOiBhbnkpID0+IHtcbiAgICAgIGlmIChpdGVtLmlkID09IGlkKSB7XG4gICAgICAgIE9iamVjdC5hc3NpZ24oaXRlbSwge1xuICAgICAgICAgIC4uLmZpZWxkcyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGFzc0xpc3QsXG4gICAgfSlcbiAgfSxcblxuICByZW1vdmVSb3coaWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHsgYXNzTGlzdCB9ID0gdGhpcy5kYXRhO1xuICAgIGNvbnN0IG5ld0xpc3QgPSBhc3NMaXN0LmZpbHRlcigoaXRlbTogYW55KSA9PiBpdGVtLmlkICE9PSBpZCk7XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGFzc0xpc3Q6IG5ld0xpc3QsXG4gICAgfSlcbiAgfSxcblxuICBvbkxvYWQoKSB7XG4gICAgLy8gY29uc3QgeyBhcHAgfSA9IHRoaXM7XG4gICAgLy8gdGhpcy5vblJlZnJlc2hEYXRhKCk7XG5cbiAgfSxcblxuICBvblNob3coKSB7XG4gICAgdGhpcy5vblJlZnJlc2hEYXRhKCk7XG4gIH0sXG5cbiAgb25QdWxsRG93blJlZnJlc2goKSB7XG4gICAgdGhpcy5vblJlZnJlc2hEYXRhKCk7XG4gIH1cblxufSkiXX0=