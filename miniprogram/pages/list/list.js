import { wxRequest } from '../../utils/request';
import { approve, stop } from '../../services/assapi';
Page({
    app: getApp(),
    data: {
        error: '',
        assList: []
    },
    onSlideButtonTap(e) {
        console.log('slide button tap', e.detail);
    },
    setError(errMsg) {
        this.setData({
            error: errMsg
        });
    },
    onRefreshData() {
        const { app } = this;
        const { token } = app.globalData.accountInfo;
        const that = this;
        wxRequest({
            url: "/ass/asslist/" + token,
        }).then((res) => {
            wx.hideLoading();
            if (res.statusCode == 200) {
                const data = res.data;
                that.setData({
                    assList: data.data
                });
            }
            else {
                that.setError(res.errMsg);
            }
        })
            .catch((res) => {
            that.setError(res.errMsg);
        });
    },
    onCellClick(e) {
        const { dataset: { id, categoryid, operation } } = e.target;
        wx.navigateTo({
            url: '/pages/detail/index',
            success: function (res) {
                res.eventChannel.emit('acceptDataFromOpenerPage', {
                    approvalid: id,
                    categoryid,
                    operation,
                });
            }
        });
    },
    onStopClick(e) {
        const { dataset: { id } } = e.target;
        const that = this;
        const row = that.searchRow(id);
        if (row) {
            that.updateRow(id, {
                loading: true,
            });
            stop({
                approvalId: row.id,
                categoryid: row.categoryid,
                comment: '快速中止 (来自:微信小程序)',
            }).then((res) => {
                const data = res.data;
                if (res.statusCode === 200) {
                    if (data.status == 200) {
                        that.removeRow(id);
                    }
                    else {
                        that.updateRow(id, {
                            error: String(data.errorMessage),
                            loading: false,
                        });
                    }
                }
                else {
                    that.updateRow(id, {
                        error: String(data.message),
                        loading: false,
                    });
                }
            }).catch((res) => {
                console.log(res);
                that.updateRow(id, {
                    error: String(res.message),
                    loading: false,
                });
            });
        }
    },
    onApproveClick(e) {
        const { dataset: { id } } = e.target;
        const that = this;
        const row = that.searchRow(id);
        if (row) {
            that.updateRow(id, {
                loading: true,
            });
            approve({
                approvalId: row.id,
                categoryid: row.categoryid,
                comment: '快速同意 (来自:微信小程序)',
            }).then((res) => {
                const data = res.data;
                if (res.statusCode === 200) {
                    if (data.status == 200) {
                        that.removeRow(id);
                    }
                    else {
                        that.updateRow(id, {
                            error: String(data.errorMessage),
                            loading: false,
                        });
                    }
                }
                else {
                    that.updateRow(id, {
                        error: String(data.message),
                        loading: false,
                    });
                }
            }).catch((res) => {
                console.log(res);
                that.updateRow(id, {
                    error: String(res.message),
                    loading: false,
                });
            });
        }
    },
    searchRow(id) {
        const { assList } = this.data;
        if (assList) {
            return assList.find((item) => item.id === id);
        }
        else {
            return undefined;
        }
    },
    updateRow(id, fields) {
        const { assList } = this.data;
        assList.map((item) => {
            if (item.id == id) {
                Object.assign(item, {
                    ...fields,
                });
            }
        });
        this.setData({
            assList,
        });
    },
    removeRow(id) {
        const { assList } = this.data;
        const newList = assList.filter((item) => item.id !== id);
        this.setData({
            assList: newList,
        });
    },
    onLoad() {
        this.onRefreshData();
    },
    onPullDownRefresh() {
        this.onRefreshData();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxpc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFdEQsSUFBSSxDQUFDO0lBQ0gsR0FBRyxFQUFFLE1BQU0sRUFBYTtJQUN4QixJQUFJLEVBQUU7UUFDSixLQUFLLEVBQUUsRUFBRTtRQUNULE9BQU8sRUFBRSxFQUFFO0tBQ1o7SUFFRCxnQkFBZ0IsQ0FBQyxDQUFNO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCxRQUFRLENBQUMsTUFBYztRQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsS0FBSyxFQUFFLE1BQU07U0FDZCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsYUFBYTtRQUNYLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDckIsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDO1FBQzdDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUNsQixTQUFTLENBQUM7WUFDUixHQUFHLEVBQUUsZUFBZSxHQUFHLEtBQUs7U0FDN0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ2QsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2pCLElBQUksR0FBRyxDQUFDLFVBQVUsSUFBSSxHQUFHLEVBQUU7Z0JBQ3pCLE1BQU0sSUFBSSxHQUFRLEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1gsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJO2lCQUNuQixDQUFDLENBQUE7YUFD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SUFFRCxpQkFBaUI7UUFDZixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQztDQUVGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIGxpc3QudHNcbmltcG9ydCB7IHd4UmVxdWVzdCB9IGZyb20gJy4uLy4uL3V0aWxzL3JlcXVlc3QnO1xuaW1wb3J0IHsgYXBwcm92ZSwgc3RvcCB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2Fzc2FwaSc7XG5cblBhZ2Uoe1xuICBhcHA6IGdldEFwcDxCcG1PcHRpb24+KCksXG4gIGRhdGE6IHtcbiAgICBlcnJvcjogJycsXG4gICAgYXNzTGlzdDogW11cbiAgfSxcblxuICBvblNsaWRlQnV0dG9uVGFwKGU6IGFueSkge1xuICAgIGNvbnNvbGUubG9nKCdzbGlkZSBidXR0b24gdGFwJywgZS5kZXRhaWwpO1xuICB9LFxuXG4gIHNldEVycm9yKGVyck1zZzogc3RyaW5nKSB7XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGVycm9yOiBlcnJNc2dcbiAgICB9KTtcbiAgfSxcblxuICBvblJlZnJlc2hEYXRhKCkge1xuICAgIGNvbnN0IHsgYXBwIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgdG9rZW4gfSA9IGFwcC5nbG9iYWxEYXRhLmFjY291bnRJbmZvO1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIHd4UmVxdWVzdCh7XG4gICAgICB1cmw6IFwiL2Fzcy9hc3NsaXN0L1wiICsgdG9rZW4sXG4gICAgfSkudGhlbigocmVzKSA9PiB7XG4gICAgICB3eC5oaWRlTG9hZGluZygpO1xuICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID09IDIwMCkge1xuICAgICAgICBjb25zdCBkYXRhOiBhbnkgPSByZXMuZGF0YTtcbiAgICAgICAgdGhhdC5zZXREYXRhKHtcbiAgICAgICAgICBhc3NMaXN0OiBkYXRhLmRhdGFcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGF0LnNldEVycm9yKHJlcy5lcnJNc2cpO1xuICAgICAgfVxuICAgIH0pXG4gICAgICAuY2F0Y2goKHJlczogV2VjaGF0TWluaXByb2dyYW0uR2VuZXJhbENhbGxiYWNrUmVzdWx0KSA9PiB7XG4gICAgICAgIHRoYXQuc2V0RXJyb3IocmVzLmVyck1zZyk7XG4gICAgICB9KTtcbiAgfSxcblxuICBvbkNlbGxDbGljayhlOiBhbnkpIHtcbiAgICBjb25zdCB7IGRhdGFzZXQ6IHsgaWQsIGNhdGVnb3J5aWQsIG9wZXJhdGlvbiB9IH0gPSBlLnRhcmdldDtcbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9kZXRhaWwvaW5kZXgnLFxuICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHJlcykge1xuICAgICAgICAvLyDpgJrov4dldmVudENoYW5uZWzlkJHooqvmiZPlvIDpobXpnaLkvKDpgIHmlbDmja5cbiAgICAgICAgcmVzLmV2ZW50Q2hhbm5lbC5lbWl0KCdhY2NlcHREYXRhRnJvbU9wZW5lclBhZ2UnLCB7XG4gICAgICAgICAgYXBwcm92YWxpZDogaWQsXG4gICAgICAgICAgY2F0ZWdvcnlpZCxcbiAgICAgICAgICBvcGVyYXRpb24sXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgb25TdG9wQ2xpY2soZTogYW55KSB7XG4gICAgY29uc3QgeyBkYXRhc2V0OiB7IGlkIH0gfSA9IGUudGFyZ2V0O1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIGNvbnN0IHJvdzogYW55ID0gdGhhdC5zZWFyY2hSb3coaWQpO1xuXG4gICAgaWYgKHJvdykge1xuICAgICAgdGhhdC51cGRhdGVSb3coaWQsIHtcbiAgICAgICAgbG9hZGluZzogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgc3RvcCh7XG4gICAgICAgIGFwcHJvdmFsSWQ6IHJvdy5pZCxcbiAgICAgICAgY2F0ZWdvcnlpZDogcm93LmNhdGVnb3J5aWQsXG4gICAgICAgIGNvbW1lbnQ6ICflv6vpgJ/kuK3mraIgKOadpeiHqjrlvq7kv6HlsI/nqIvluo8pJyxcbiAgICAgIH0pLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICBjb25zdCBkYXRhOiBhbnkgPSByZXMuZGF0YTtcbiAgICAgICAgaWYocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgIGlmKGRhdGEuc3RhdHVzID09IDIwMCkge1xuICAgICAgICAgICAgdGhhdC5yZW1vdmVSb3coaWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoYXQudXBkYXRlUm93KGlkLCB7XG4gICAgICAgICAgICAgIGVycm9yOiBTdHJpbmcoZGF0YS5lcnJvck1lc3NhZ2UpLFxuICAgICAgICAgICAgICBsb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICB0aGF0LnVwZGF0ZVJvdyhpZCwge1xuICAgICAgICAgICAgZXJyb3I6IFN0cmluZyhkYXRhLm1lc3NhZ2UpLFxuICAgICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKChyZXMpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2cocmVzKTtcbiAgICAgICAgdGhhdC51cGRhdGVSb3coaWQsIHtcbiAgICAgICAgICBlcnJvcjogU3RyaW5nKHJlcy5tZXNzYWdlKSxcbiAgICAgICAgICBsb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgb25BcHByb3ZlQ2xpY2soZTogYW55KSB7XG4gICAgY29uc3QgeyBkYXRhc2V0OiB7IGlkIH0gfSA9IGUudGFyZ2V0O1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIGNvbnN0IHJvdzogYW55ID0gdGhhdC5zZWFyY2hSb3coaWQpO1xuXG4gICAgaWYgKHJvdykge1xuICAgICAgdGhhdC51cGRhdGVSb3coaWQsIHtcbiAgICAgICAgbG9hZGluZzogdHJ1ZSxcbiAgICAgIH0pO1xuICAgICAgYXBwcm92ZSh7XG4gICAgICAgIGFwcHJvdmFsSWQ6IHJvdy5pZCxcbiAgICAgICAgY2F0ZWdvcnlpZDogcm93LmNhdGVnb3J5aWQsXG4gICAgICAgIGNvbW1lbnQ6ICflv6vpgJ/lkIzmhI8gKOadpeiHqjrlvq7kv6HlsI/nqIvluo8pJyxcbiAgICAgIH0pLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICBjb25zdCBkYXRhOiBhbnkgPSByZXMuZGF0YTtcbiAgICAgICAgaWYocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgIGlmKGRhdGEuc3RhdHVzID09IDIwMCkge1xuICAgICAgICAgICAgdGhhdC5yZW1vdmVSb3coaWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoYXQudXBkYXRlUm93KGlkLCB7XG4gICAgICAgICAgICAgIGVycm9yOiBTdHJpbmcoZGF0YS5lcnJvck1lc3NhZ2UpLFxuICAgICAgICAgICAgICBsb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICB0aGF0LnVwZGF0ZVJvdyhpZCwge1xuICAgICAgICAgICAgZXJyb3I6IFN0cmluZyhkYXRhLm1lc3NhZ2UpLFxuICAgICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKChyZXMpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2cocmVzKTtcbiAgICAgICAgdGhhdC51cGRhdGVSb3coaWQsIHtcbiAgICAgICAgICBlcnJvcjogU3RyaW5nKHJlcy5tZXNzYWdlKSxcbiAgICAgICAgICBsb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG5cbiAgc2VhcmNoUm93KGlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB7IGFzc0xpc3QgfSA9IHRoaXMuZGF0YTtcbiAgICBpZiAoYXNzTGlzdCkge1xuICAgICAgcmV0dXJuIGFzc0xpc3QuZmluZCgoaXRlbTogYW55KSA9PiBpdGVtLmlkID09PSBpZCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH0sXG5cbiAgdXBkYXRlUm93KGlkOiBzdHJpbmcsIGZpZWxkczogYW55KSB7XG4gICAgY29uc3QgeyBhc3NMaXN0IH0gPSB0aGlzLmRhdGE7XG4gICAgYXNzTGlzdC5tYXAoKGl0ZW06IGFueSkgPT4ge1xuICAgICAgaWYgKGl0ZW0uaWQgPT0gaWQpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihpdGVtLCB7XG4gICAgICAgICAgLi4uZmllbGRzLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgYXNzTGlzdCxcbiAgICB9KVxuICB9LFxuXG4gIHJlbW92ZVJvdyhpZDogc3RyaW5nKSB7XG4gICAgY29uc3QgeyBhc3NMaXN0IH0gPSB0aGlzLmRhdGE7XG4gICAgY29uc3QgbmV3TGlzdCA9IGFzc0xpc3QuZmlsdGVyKChpdGVtOiBhbnkpID0+IGl0ZW0uaWQgIT09IGlkKTtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgYXNzTGlzdDogbmV3TGlzdCxcbiAgICB9KVxuICB9LFxuXG4gIG9uTG9hZCgpIHtcbiAgICAvLyBjb25zdCB7IGFwcCB9ID0gdGhpcztcbiAgICB0aGlzLm9uUmVmcmVzaERhdGEoKTtcblxuICB9LFxuXG4gIG9uUHVsbERvd25SZWZyZXNoKCkge1xuICAgIHRoaXMub25SZWZyZXNoRGF0YSgpO1xuICB9XG5cbn0pIl19